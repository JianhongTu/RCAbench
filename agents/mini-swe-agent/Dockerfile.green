# Dockerfile for green agent container (mini-swe-agent)
# This container runs the green agent that controls ARVO containers

FROM ghcr.io/astral-sh/uv:python3.13-bookworm

ENV UV_HTTP_TIMEOUT=300

# Install Docker CLI (to execute commands in arvo containers)
RUN apt-get update && apt-get install -y \
    docker.io \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies using UV (before creating user)
RUN uv pip install --system \
    openai>=1.0.0 \
    docker>=7.1.0 \
    uvicorn \
    a2a-sdk

# Create non-root user
RUN adduser --disabled-password --gecos '' agent
USER agent

# Set working directory
WORKDIR /home/agent

# Copy agent code
COPY agents/mini-swe-agent/docker_environment.py agents/mini-swe-agent/green_agent_server.py agents/mini-swe-agent/utility.py ./

# Copy src directory for agentbeats and rcabench modules
COPY src/ /home/agent/src/

# Note: For docker-compose, src/ can be mounted as volume for live updates
# For standalone deployment (AgentBeats), src/ is baked into the image

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV DOCKER_HOST=unix:///var/run/docker.sock
ENV PYTHONPATH=/home/agent:/home/agent/src:/workspace

# Expose port
EXPOSE 9009

# Use ENTRYPOINT/CMD pattern with UV
ENTRYPOINT ["uv", "run", "green_agent_server.py"]
CMD ["--host", "0.0.0.0", "--port", "9009"]
