# Docker Compose setup for mini-swe-agent with green and purple agents
# 
# Container 1: green-agent (Green Agent) - controls ARVO containers, executes commands
# Container 2: purple-agent (Purple Agent) - decides commands, performs analysis
# Container 3: arvo (C/C++) - executes code compilation/testing commands (created dynamically)
#
# Usage:
#   docker-compose -f agents/mini-swe-agent/docker-compose.yml up

version: '3.8'

services:
  green-agent:
    build:
      context: ../../
      dockerfile: agents/mini-swe-agent/Dockerfile.green
    image: mini-swe-agent-green:latest
    container_name: green-agent
    ports:
      - "9009:9009"  # A2A server port
    volumes:
      - ${WORKSPACE_DIR:-./workspace}:/workspace:rw
      - /var/run/docker.sock:/var/run/docker.sock  # Access to Docker daemon
      - ${LOG_DIR:-./logs}/green:/home/agent/logs:rw
      - ${TMP_DIR:-/tmp/rcabench}:/tmp/rcabench:rw
      - ../../src:/home/agent/src:ro  # Mount agentbeats and rcabench source
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MODEL=${MODEL}
      - PYTHONPATH=/home/agent:/home/agent/src:/workspace
    command: ["--host", "0.0.0.0", "--port", "9009"]
    networks:
      - agent-network
    restart: unless-stopped

  purple-agent:
    build:
      context: ../../
      dockerfile: agents/mini-swe-agent/Dockerfile.purple
    image: mini-swe-agent-purple:latest
    container_name: purple-agent
    ports:
      - "9019:9019"  # A2A server port
    volumes:
      - ${WORKSPACE_DIR:-./workspace}:/workspace:ro  # Read-only access
      - ${LOG_DIR:-./logs}/purple:/home/agent/logs:rw
      - ../../src:/home/agent/src:ro  # Mount agentbeats source
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GREEN_AGENT_URL=http://green-agent:9009/
      - MODEL=${MODEL}
      - MAX_STEPS=${MAX_STEPS:-50}
      - PYTHONPATH=/home/agent:/home/agent/src:/workspace
    command: ["--host", "0.0.0.0", "--port", "9019", "--green-agent-url", "http://green-agent:9009/"]
    networks:
      - agent-network
    depends_on:
      - green-agent
    restart: unless-stopped

  # Note: arvo containers are created dynamically per task by green agent
  # They are not defined here but created via docker.containers.run() in docker_environment.py

networks:
  agent-network:
    driver: bridge

